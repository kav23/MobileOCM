
#Область ПрограммныйИнтерфейс

Процедура ПолучитьВерсиюДрайвераОборудования(Форма, ПодключаемоеОборудование, Версия, ВерсияВМакете, ДрайверУстановлен) Экспорт
	
	ВыходныеПараметры = Неопределено;
	
	Если Не ЗначениеЗаполнено(ПодключаемоеОборудование) Тогда
		Версия = "";
		ДрайверУстановлен = Ложь;
		Возврат;
	КонецЕсли;
	
	#Если МобильноеПриложениеКлиент Тогда
		
		Если МенеджерОборудованияКлиент.ПолучитьВерсиюДрайвера(Форма.УникальныйИдентификатор, ПодключаемоеОборудование, Неопределено, ВыходныеПараметры) Тогда
			Версия = ?(ПустаяСтрока(ВыходныеПараметры.ВерсияДрайвера), "Неопределено", ВыходныеПараметры.ВерсияДрайвера);
			ДрайверУстановлен = Истина;
			
		Иначе
			Версия = НСтр("ru = 'Драйвер не установлен'");
			ДрайверУстановлен = Ложь;
		КонецЕсли;
		
		ВерсияВМакете = ВыходныеПараметры.ВерсияДрайвераВМакете;
		
	#Иначе
		ДрайверУстановлен = Ложь;
		Версия = НСтр("ru = 'Только из мобильного приложения'");
	#КонецЕсли
	
КонецПроцедуры

Процедура ПолучитьШтрихкод(ДополнительныеПараметры) Экспорт
	
	ЗаголовокСканирования = НСтр("ru = 'Считайте штрихкод'");
	
	Если ДополнительныеПараметры.Свойство("ЗаголовокСканирования") Тогда
		ЗаголовокСканирования = ДополнительныеПараметры.ЗаголовокСканирования;
	КонецЕсли;
	
	#Если МобильноеПриложениеКлиент Тогда
			
		Если ЗначениеНастроекВызовСервераПовтИсп.СканированиеВнешнимСканером() Тогда
			
			ВыходныеПараметры = Неопределено;
			
			Успешно = Истина;
			Если Не МенеджерОборудованияКлиент.ВыполнитьВводДанных(
				ДополнительныеПараметры.Форма.УникальныйИдентификатор,
				ЗначениеНастроекВызовСервераПовтИсп.ОборудованиеСканированияШтрихкодов(),
				ВыходныеПараметры) Тогда
				
				ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ВыходныеПараметры.ТекстОшибки);
				Успешно = Ложь;
			КонецЕсли;
			
			Если Успешно И ВыходныеПараметры.Свойство("ДанныеВвода") Тогда
				
				Если ЗначениеЗаполнено(ВыходныеПараметры.ДанныеВвода) Тогда
					ДополнительныеПараметры.Форма.ОбработатьПолученныйШтрихкод(ВыходныеПараметры.ДанныеВвода, ДополнительныеПараметры);
				КонецЕсли;
				
			КонецЕсли;
			
		Иначе
			
			ОбработчикСканирования = Новый ОписаниеОповещения("ОбработкаСканирования", ПодключаемоеОборудованиеКлиент, ДополнительныеПараметры);
			ОбработчикЗакрытияСканирования = Новый ОписаниеОповещения(ДополнительныеПараметры.ИмяОбработчикаЗакрытияСканирования, 
				ДополнительныеПараметры.Форма, ДополнительныеПараметры);

			СредстваМультимедиа.ПоказатьСканированиеШтрихКодов(ЗаголовокСканирования, ОбработчикСканирования, ОбработчикЗакрытияСканирования);
			
		КонецЕсли;
		
	#Иначе
		
		Штрихкод = "";
		ОписаниеОповещения = Новый ОписаниеОповещения("ОповещениеПоискаПоШтрихкодуПК", ЭтотОбъект, ДополнительныеПараметры);
		
		ПоказатьВводСтроки(ОписаниеОповещения, Штрихкод, ЗаголовокСканирования);
		
	#КонецЕсли
	
КонецПроцедуры

// Функция возвращает контрольный символ штрихкода EAN13.
//
// Параметры:
//  Штрихкод - Строка
//           - Неполный штрихкод (12 символов), для которого вычисляется
//             контрольный 13-й символ.
//
// Возвращаемое значение:
//  Строка - Контрольный символ EAN13.
//
Функция КонтрольныйСимволEAN13(Штрихкод) Экспорт
	
	Результат   = "";
	Сумма       = 0;
	Коэффициент = 1;
	
	Для Индекс = 1 По 12 Цикл
		ВремКодСимвола = КодСимвола(Штрихкод, Индекс);
		Сумма       = Сумма + Коэффициент * (ВремКодСимвола - 48);
		Коэффициент = 4 - Коэффициент;
	КонецЦикла;
	Сумма     = (10 - Сумма % 10) % 10;
	Результат = Символ(Сумма + 48);
	
	Возврат Результат;
	
КонецФункции

Процедура РаспечататьЭтикетки(Форма, Товары, РежимПечати) Экспорт
	
	ОчиститьСообщения();
	
	ЭтикеткиДляПечати = Новый Массив();
	
	Если РежимПечати = "ПечатьЭтикеток" Тогда
		
		ШаблонПечати = ЗначениеНастроекВызовСервераПовтИсп.ШаблонЭтикетки();
		
	ИначеЕсли РежимПечати = "ПечатьЦенников" Тогда
		
		ШаблонПечати = ЗначениеНастроекВызовСервераПовтИсп.ШаблонЦенника();
		
	КонецЕсли;
	
	// Шапка - Штрихкод - Подвал
	ЭлементыВШапку = Истина;
	МакетШапки = "";
	МакетПодвала = "";
	
	СимволТега = "%";
	
	Для Каждого ЭлементПечати Из ШаблонПечати Цикл
		
		Если НЕ ЭлементПечати.Пометка Тогда
			Продолжить;
		КонецЕсли;
		
		Если ЭлементПечати.Значение = "Штрихкод" Тогда
			
			ЭлементыВШапку = Ложь;
			
		Иначе
			
			ТекстВМакет = СимволТега + ЭлементПечати.Значение + СимволТега;
			
			Если ЭлементыВШапку Тогда
				МакетШапки = ?(МакетШапки = "", ТекстВМакет, МакетШапки + Символы.ПС + ТекстВМакет);
			Иначе
				МакетПодвала = ?(МакетПодвала = "", ТекстВМакет, МакетПодвала + Символы.ПС + ТекстВМакет);
			КонецЕсли;
		КонецЕсли;
		
	КонецЦикла;
	
	ДатаПечати = Формат(ОбщегоНазначенияКлиентСервер.ПолучитьТекущуюДату(), "ДФ=dd.MM.yyyy");
	
	Для Каждого ВремТовар Из Товары Цикл
		
		КоличествоКопий = ВремТовар.Количество;
		
		Если КоличествоКопий = 0 Тогда
			Продолжить;
		КонецЕсли;
		
		Этикетка = Новый Структура();
		
		ШапкаЭтикетки = МакетШапки;
		ПодвалЭтикетки = МакетПодвала;
		
		ШапкаЭтикетки = СтрЗаменить(ШапкаЭтикетки, "%НаименованиеОрганизации%",
			ЗначениеНастроекВызовСервераПовтИсп.НаименованиеОрганизации()
		);
		
		ПодвалЭтикетки = СтрЗаменить(ПодвалЭтикетки, "%НаименованиеОрганизации%",
			ЗначениеНастроекВызовСервераПовтИсп.НаименованиеОрганизации()
		);
		
		ШапкаЭтикетки = СтрЗаменить(ШапкаЭтикетки, "%НаименованиеТовара%", ВремТовар.Номенклатура);
		ПодвалЭтикетки = СтрЗаменить(ПодвалЭтикетки, "%НаименованиеТовара%", ВремТовар.Номенклатура);
		
		ШапкаЭтикетки = СтрЗаменить(ШапкаЭтикетки, "%Артикул%", ВремТовар.Артикул);
		ПодвалЭтикетки = СтрЗаменить(ПодвалЭтикетки, "%Артикул%", ВремТовар.Артикул);
		
		ШапкаЭтикетки = СтрЗаменить(ШапкаЭтикетки, "%ДатаПечати%", ДатаПечати);
		ПодвалЭтикетки = СтрЗаменить(ПодвалЭтикетки, "%ДатаПечати%", ДатаПечати);
		
		НадписьЦена = НСтр("ru = 'ЦЕНА: %Цена% Руб.'");
		НадписьЦена = СтрЗаменить(НадписьЦена, "%Цена%", Формат(ВремТовар.Цена, "ЧЦ=10; ЧДЦ=2; ЧРД=.; ЧН=0.00; ЧГ=0"));
		
		ШапкаЭтикетки = СтрЗаменить(ШапкаЭтикетки, "%Цена%", НадписьЦена);
		ПодвалЭтикетки = СтрЗаменить(ПодвалЭтикетки, "%Цена%", НадписьЦена);
		
		Этикетка.Вставить("ШапкаЭтикетки" , ШапкаЭтикетки);
		
		Если ЗначениеЗаполнено(ВремТовар.Штрихкод) Тогда
			Этикетка.Вставить("ТипШтрихкода", МенеджерОборудованияКлиент.ОпределитьТипШтрихкода(ВремТовар.Штрихкод));
			Этикетка.Вставить("Штрихкод"    , ВремТовар.Штрихкод);
		КонецЕсли;
		
		Этикетка.Вставить("ПодвалЭтикетки", ПодвалЭтикетки);
		
		Для Счетчик = 1 По КоличествоКопий Цикл
			ЭтикеткиДляПечати.Добавить(Этикетка);
		КонецЦикла;
		
	КонецЦикла;
	
	ВходныеПараметры = Новый Структура("Этикетки", ЭтикеткиДляПечати);
	ВыходныеПараметры = Неопределено;
	
	Если НЕ МенеджерОборудованияКлиент.ВыполнитьПечатьЭтикеток(
		Форма.УникальныйИдентификатор,
		ЗначениеНастроекВызовСервераПовтИсп.ОборудованиеПечати(),
		ВходныеПараметры,
		ВыходныеПараметры) Тогда
		
		ОбщегоНазначенияКлиентСервер.СообщитьПользователю(ВыходныеПараметры.ТекстОшибки);
		
	КонецЕсли;

КонецПроцедуры

#КонецОбласти

#Область СлужебныеПроцедурыИФункции

Процедура ОбработкаСканирования(Штрихкод, Результат, Сообщение, ДополнительныеПараметры) Экспорт
	
	Если НЕ ДополнительныеПараметры.Свойство("ПотоковоеСканирование") Тогда
		
		#Если МобильноеПриложениеКлиент Тогда
			СредстваМультимедиа.ЗакрытьСканированиеШтрихКодов();
		#КонецЕсли
		
	КонецЕсли;
	
	Если Результат = Неопределено Тогда
		Возврат;
	КонецЕсли;
	
	ДополнительныеПараметры.Форма.ОбработатьПолученныйШтрихкод(Штрихкод, ДополнительныеПараметры);
	
КонецПроцедуры

Процедура ОповещениеПоискаПоШтрихкодуПК(Результат, ДополнительныеПараметры) Экспорт
	
	Если НЕ Результат = Неопределено Тогда
		
		ДополнительныеПараметры.Форма.ОбработатьПолученныйШтрихкод(Результат, ДополнительныеПараметры);
		
	КонецЕсли;
	
КонецПроцедуры

#КонецОбласти
